export interface Vulnerability {
  id: string;
  title: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  description: string;
  solution: string;
  cve?: string;
  cvss?: number;
}

export interface ScanResult {
  target: string;
  vulnerabilities: Vulnerability[];
  scanDate: string;
  status: 'completed' | 'failed' | 'in_progress';
}

export async function scanForVulnerabilities(target: string): Promise<ScanResult> {
  // Mock vulnerability scan - replace with actual Nessus/OpenVAS integration
  const mockVulnerabilities: Vulnerability[] = [
    {
      id: 'vuln-001',
      title: 'Outdated SSL/TLS Configuration',
      severity: 'medium',
      description: 'The target uses outdated SSL/TLS protocols that may be vulnerable to known attacks.',
      solution: 'Update to TLS 1.2 or higher and disable weak cipher suites.',
      cve: 'CVE-2014-3566',
      cvss: 6.4
    },
    {
      id: 'vuln-002',
      title: 'Missing Security Headers',
      severity: 'low',
      description: 'Important security headers like HSTS, CSP, and X-Frame-Options are missing.',
      solution: 'Implement comprehensive security headers to protect against common web vulnerabilities.',
      cvss: 3.7
    },
    {
      id: 'vuln-003',
      title: 'Information Disclosure',
      severity: 'low',
      description: 'Server version information is exposed in HTTP headers.',
      solution: 'Configure server to hide version information and sensitive details.',
      cvss: 2.1
    }
  ];

  // Simulate scan delay
  await new Promise(resolve => setTimeout(resolve, 2000));

  return {
    target,
    vulnerabilities: mockVulnerabilities,
    scanDate: new Date().toISOString(),
    status: 'completed'
  };
}

export async function performNessusScan(target: string): Promise<any> {
  // Mock Nessus scan - replace with actual Nessus API integration
  await new Promise(resolve => setTimeout(resolve, 1500));
  
  // Check if it's a known vulnerable test site
  const isVulnerableTestSite = target.includes('testphp.vulnweb.com') || 
                               target.includes('vulnweb.com') || 
                               target.includes('test') ||
                               target.includes('vulnerable');
  
  if (isVulnerableTestSite) {
    return {
      target,
      scan_id: 'nessus-scan-' + Date.now(),
      scan_name: 'Vulnerability Assessment',
      status: 'completed',
      scan_date: new Date().toISOString(),
      total_vulnerabilities: 8,
      critical_count: 2,
      high_count: 3,
      medium_count: 2,
      low_count: 1,
      vulnerabilities: [
        {
          id: 'vuln-001',
          title: 'SQL Injection Vulnerability',
          severity: 'CRITICAL',
          description: 'The application is vulnerable to SQL injection attacks through user input parameters. This allows attackers to access and manipulate the database.',
          solution: 'Implement parameterized queries and input validation to prevent SQL injection attacks.',
          cve: 'CVE-2023-1234',
          cvss_score: 9.8,
          affected_software: ['PHP/7.4', 'MySQL/5.7'],
          references: ['https://owasp.org/www-community/attacks/SQL_Injection'],
          published_date: '2023-01-15T00:00:00Z',
          last_modified: '2023-01-15T00:00:00Z'
        },
        {
          id: 'vuln-002',
          title: 'Cross-Site Scripting (XSS)',
          severity: 'CRITICAL',
          description: 'Reflected XSS vulnerability found in search functionality. Attackers can inject malicious scripts.',
          solution: 'Implement proper input sanitization and output encoding.',
          cve: 'CVE-2023-1235',
          cvss_score: 8.2,
          affected_software: ['PHP/7.4', 'Apache/2.4'],
          references: ['https://owasp.org/www-community/attacks/xss/'],
          published_date: '2023-01-16T00:00:00Z',
          last_modified: '2023-01-16T00:00:00Z'
        },
        {
          id: 'vuln-003',
          title: 'Directory Traversal',
          severity: 'HIGH',
          description: 'The application allows directory traversal attacks, potentially exposing sensitive files.',
          solution: 'Implement proper path validation and restrict file access.',
          cve: 'CVE-2023-1236',
          cvss_score: 7.5,
          affected_software: ['PHP/7.4'],
          references: ['https://owasp.org/www-community/attacks/Path_Traversal'],
          published_date: '2023-01-17T00:00:00Z',
          last_modified: '2023-01-17T00:00:00Z'
        },
        {
          id: 'vuln-004',
          title: 'File Upload Vulnerability',
          severity: 'HIGH',
          description: 'Unrestricted file upload functionality allows malicious file uploads.',
          solution: 'Implement file type validation and upload restrictions.',
          cve: 'CVE-2023-1237',
          cvss_score: 7.2,
          affected_software: ['PHP/7.4'],
          references: ['https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload'],
          published_date: '2023-01-18T00:00:00Z',
          last_modified: '2023-01-18T00:00:00Z'
        },
        {
          id: 'vuln-005',
          title: 'Authentication Bypass',
          severity: 'HIGH',
          description: 'Weak authentication mechanism allows unauthorized access.',
          solution: 'Implement strong authentication and session management.',
          cve: 'CVE-2023-1238',
          cvss_score: 6.8,
          affected_software: ['PHP/7.4'],
          references: ['https://owasp.org/www-community/controls/Authentication'],
          published_date: '2023-01-19T00:00:00Z',
          last_modified: '2023-01-19T00:00:00Z'
        },
        {
          id: 'vuln-006',
          title: 'Information Disclosure',
          severity: 'MEDIUM',
          description: 'Sensitive information is exposed in error messages and responses.',
          solution: 'Implement proper error handling and information disclosure controls.',
          cve: 'CVE-2023-1239',
          cvss_score: 5.3,
          affected_software: ['PHP/7.4', 'Apache/2.4'],
          references: ['https://owasp.org/www-community/attacks/Information_disclosure'],
          published_date: '2023-01-20T00:00:00Z',
          last_modified: '2023-01-20T00:00:00Z'
        },
        {
          id: 'vuln-007',
          title: 'Missing Security Headers',
          severity: 'MEDIUM',
          description: 'Important security headers are missing, reducing protection against common attacks.',
          solution: 'Implement comprehensive security headers (HSTS, CSP, X-Frame-Options).',
          cve: 'CVE-2023-1240',
          cvss_score: 4.2,
          affected_software: ['Apache/2.4'],
          references: ['https://owasp.org/www-project-secure-headers/'],
          published_date: '2023-01-21T00:00:00Z',
          last_modified: '2023-01-21T00:00:00Z'
        },
        {
          id: 'vuln-008',
          title: 'Outdated Software Version',
          severity: 'LOW',
          description: 'The application uses outdated software versions with known vulnerabilities.',
          solution: 'Update all software components to their latest secure versions.',
          cve: 'CVE-2023-1241',
          cvss_score: 3.1,
          affected_software: ['PHP/7.4', 'Apache/2.4.41'],
          references: ['https://www.php.net/supported-versions.php'],
          published_date: '2023-01-22T00:00:00Z',
          last_modified: '2023-01-22T00:00:00Z'
        }
      ]
    };
  }
  
  // Default response for other sites
  return {
    target,
    scan_id: 'nessus-scan-' + Date.now(),
    scan_name: 'Vulnerability Assessment',
    status: 'completed',
    scan_date: new Date().toISOString(),
    total_vulnerabilities: 3,
    critical_count: 0,
    high_count: 1,
    medium_count: 1,
    low_count: 1,
    vulnerabilities: [
      {
        id: 'vuln-001',
        title: 'Outdated SSL/TLS Configuration',
        severity: 'MEDIUM',
        description: 'The target uses outdated SSL/TLS protocols that may be vulnerable to known attacks.',
        solution: 'Update to TLS 1.2 or higher and disable weak cipher suites.',
        cve: 'CVE-2014-3566',
        cvss_score: 6.4,
        affected_software: ['Apache/2.4.41', 'OpenSSL/1.1.1'],
        references: ['https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-3566'],
        published_date: '2014-10-14T00:00:00Z',
        last_modified: '2023-01-01T00:00:00Z'
      },
      {
        id: 'vuln-002',
        title: 'Missing Security Headers',
        severity: 'LOW',
        description: 'Important security headers like HSTS, CSP, and X-Frame-Options are missing.',
        solution: 'Implement comprehensive security headers to protect against common web vulnerabilities.',
        cvss_score: 3.7,
        affected_software: ['Web Server'],
        references: ['https://owasp.org/www-project-secure-headers/'],
        published_date: '2020-01-01T00:00:00Z',
        last_modified: '2023-01-01T00:00:00Z'
      },
      {
        id: 'vuln-003',
        title: 'Information Disclosure',
        severity: 'LOW',
        description: 'Server version information is exposed in HTTP headers.',
        solution: 'Configure server to hide version information and sensitive details.',
        cvss_score: 2.1,
        affected_software: ['Apache/2.4.41'],
        references: ['https://httpd.apache.org/docs/2.4/mod/core.html#servertokens'],
        published_date: '2019-01-01T00:00:00Z',
        last_modified: '2023-01-01T00:00:00Z'
      }
    ]
  };
}
